<!DOCTYPE html>
<head>
    <title>{{name}}</title>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <style>
        body{
            font-size: x-large;
        }
        .switch {
  position: relative;
  display: inline-block;
  width: 60px;
  height: 34px;
}

.switch input { 
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  -webkit-transition: .4s;
  transition: .4s;
}

.slider:before {
  position: absolute;
  content: "";
  height: 26px;
  width: 26px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  -webkit-transition: .4s;
  transition: .4s;
}

input:checked + .slider {
  background-color: #2196F3;
}

input:focus + .slider {
  box-shadow: 0 0 1px #2196F3;
}

input:checked + .slider:before {
  -webkit-transform: translateX(26px);
  -ms-transform: translateX(26px);
  transform: translateX(26px);
}

/* Rounded sliders */
.slider.round {
  border-radius: 34px;
}

.slider.round:before {
  border-radius: 50%;
}

    </style>
</head>
<body>
    <h1>{{name}}</h1>
    <form id="frameselect">
        <div>
            <label for="frame">Choose the frame to show:</label>
            <select name="frame" id="frame">
            {{render_frameoptions(items)}}
            </select>
        </div>

        <div>
            <label for="duration">Duration is seconds:</label>
            <select name="duration" id="duration">
            {{render_options(range(1,10), 5)}}
            </select>
        </div>


        <div>
            <label for="submit">Action:</label>
            <input type="submit" id="submit" name="submit" value="Load" />
        </div>
    </form>


   
<label for="sighting">Sighting Dots</label>
<label class="switch">
  <input type="checkbox" name="sightingdots" id="sightingdots">
  <span class="slider round"></span>
</label>

    <div id="feedback">
    </div>
    <a href="/">Home</a>


<script>
const form = document.querySelector("#frameselect");
const frame = document.querySelector("#frame");
const submit = document.querySelector("#submit");
const feedback = document.querySelector("#feedback");
const sightingdots = document.querySelector("#sightingdots");
const body = document.querySelector("body");
var loaded = ""
var bConnected = false

const CAMERAURL = "{{CAMERAURL}}"
console.log("CAMERAURL value", CAMERAURL)
async function sendData() {
  // Associate the FormData object with the form element
  const formData = new FormData(form);
  //console.log("formData", formData)
  if (loaded == ""){
    feedback.innerHTML ="Loading"
    try {
        const response = await fetch("/load/"+formData.get("frame"), {
        method: "GET",
        // Set the FormData instance as the request body
        });
        const stickframe = await response.json();
        feedback.innerHTML = "Loaded<br />Image is "+stickframe.widthCM+"cm wide"
        submit.setAttribute("value", "Show")
        loaded = formData.get("frame")
    } catch (e) { 
        unload("Load Failed")
        console.error(e);
    }
  } else {
    sightingdots.checked = false
    feedback.innerHTML = "Showing"
    await sendShutter()
    
    body.style.backgroundColor = "black";
    try {    
        const response = await fetch("/show/"+formData.get("duration")+"/"+formData.get("frame"), {
        method: "GET",
        // Set the FormData instance as the request body
        });
        const showdata = await response.json();
        feedback.innerHTML = "Shown"

        await sendShutter("release")


        body.style.backgroundColor = "white";
    } catch (e) {
        await sendShutter("release")
        unload("Show Failed")
        console.error(e);
    }

        
  }
}

// Take over form submission
form.addEventListener("submit", (event) => {
  event.preventDefault();
  sendData();
});

frame.addEventListener("change", (event) => {
    unload()
});

function unload(msg=""){
    feedback.innerHTML = msg
    loaded = ""
    submit.setAttribute("value", "Load")
    body.style.backgroundColor = "white";
}

async function sendConnect() {
  // Associate the FormData object with the form element
  try {
        const response = await fetch(CAMERAURL, {
        method: "GET",
        mode:    "no-cors",
        // Set the FormData instance as the request body
        });
        feedback.innerHTML = "Camera Connected"
        bConnected = true
    } catch (e) {
        bConnected = false
        unload("Camera Connect failed")
        console.error(e);
    }
}

async function sendSightingDots(on) {
  // Associate the FormData object with the form element
  console.log("sendSightingDots", on)
  try {
        const response = await fetch("/sightingdots/"+on, {
        method: "GET",
        // Set the FormData instance as the request body
        });
        status = "off"
        if(on){
            status = "on"
        }
        feedback.innerHTML = "Sighting Dots "+status

    } catch (e) {
        feedback.innerHTML = "Sighting Dots changed failed"
        console.error(e);
    }
}

async function sendShutter(action="full_press") { // ["full_press", "half_press", "release"]:
  if (bConnected == false){
    return
  }
  // Associate the FormData object with the form element
  try {
    feedback.innerHTML = "Shutter "+action
    const data = {"af": false,
                        "action": action
                    }

        const response = await fetch(CAMERAURL+"/ver100/shooting/control/shutterbutton/manual", {
        mode:    "no-cors",
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                // 'Content-Type': 'application/x-www-form-urlencoded',
                },
                redirect: "follow", // manual, *follow, error
                referrerPolicy: "no-referrer", // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
                body: JSON.stringify(data), 
        });
        feedback.innerHTML = "Shutter "+action+" done"
    } catch (e) {
        feedback.innerHTML = "Shutter "+action +" possible"
        console.error(e);
    }
}

document.addEventListener("readystatechange", (event) => {
  console.log("sendConnect")
  sendConnect();
});

sightingdots.addEventListener("change", (event) => {
  on = 0
  if (sightingdots.checked == true){
    on = 1
  }
  console.log("sightingdots", event, on)
  sendSightingDots(on);
});


</script>


</body>
